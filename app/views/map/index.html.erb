<!DOCTYPE html>
<html>
<head>
	<title>MappyData</title>
	<%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
	<%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
	<%= csrf_meta_tags %>
	<%= alertify_flash %>

	<script src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyDo0NtFEmgkNmZZwrxpDqyXLJDTor37EV8&libraries=drawing,places,geometry" type="text/javascript" >
	</script>

	<style type="text/css">
	
	 	html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#map { 
			height: 94%; 
			width: 100%;
			margin: 0;
			padding: 0;
		}

		#geolocateUI, #clearMapUI, #changeDBServerUI {
			background-color: #fff;
			border: 2px solid #fff;
			border-radius: 3px;
			box-shadow: 0 2px 6px rgba(0,0,0,.3);
			cursor: pointer;
			float: left;
			margin: 5px 10px 0 0;
			text-align: center;
		}

		#geolocateText, #clearMapText, #changeDBServerUI {
			color: rgb(25,25,25);
			font-family: Roboto,Arial,sans-serif;
			font-size: 15px;
			line-height: 25px;
			padding-left: 5px;
			padding-right: 5px;
		}

		#clearMapUI {
			margin-left: 12px;
		}

		.controls {
			margin-top: 10px;
			border: 1px solid transparent;
			border-radius: 2px 0 0 2px;
			box-sizing: border-box;
			-moz-box-sizing: border-box;
			height: 32px;
			outline: none;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
		}

		#pac-input {
			background-color: #fff;
			font-family: Roboto;
			font-size: 15px;
			font-weight: 300;
			margin-left: 0px;
			padding: 0 11px 0 13px;
			text-overflow: ellipsis;
			width: 300px;
		}

		#pac-input: focus {
			border-color: #4d90fe;
		}

		.pac-container {
			font-family: Roboto;
		}

		#type-selector {
			color: #fff;
			background-color: : #4d90fe;
			padding: 5px 11px 0px 11px;
		}

		#type-selector label {
			font-family: Roboto;
			font-size: 13px;
			font-weight: 300;
		}

		#panel, #flip, #info {
		    padding: 15px;
		    text-align: center;
		    background-color: rgb(45, 49, 63);
		    border: solid 1px #c3c3c3;
			color: #fff;
			font-family: Roboto,Arial,sans-serif;
			font-size: 15px;	    
		}

		#flip {
			color:orange;
		}

		#panel {
		    padding: 15px;
		    display: none;
		}

/*		#info{
			padding: 5px;
		}*/


	</style>


</head>

<body>

	<div id="flip">Click here for more information about this website.</div>
	<div id="panel">Given a polygon on the map, calculate and display population and housing counts based on 2010 U.S. Census Blocks.</br></br>Tools / Components</br>Ruby - Rails - JS - <a style=color:yellow href= "https://www.route360.net" target="_blank">Route360</a> - Google Maps API - PostgreSQL/PostGIS - 2010 USA Census Data</br></br>By clicking on the map with the marker tool (upper left), a 3 minute isochrone (drive-time) polygon is calculated using Route360 REST Services and is subsequently inserted into a PostgreSQL/PostGIS table.  The isochrone polygon is then buffered and used to do a spatial query in PostgreSQL to determine intersection of the buffered isochrone polygon against census block data.</br></br>Uniform distribution of population and housing counts are assumed within a census block.</br></br>The buffered polygon is then displayed on the map.  Within the buffered polygon is also displayed the original Route360 returned isochrone polygon(s) and line work.</br> (cool stuff, check them out ==> <a style=color:yellow href="https://www.route360.net" target="_blank">Route360.net</a>)</br></br>PostgreSQL is hosted on a Raspberry Pi 2 board running Raspbian 8 (Jessie).  The Census Block table in the database contains over 11 millions records covering the entire United States.</br></br>PostgreSQL queries executed on the Raspberry Pi 2 is a known speed bottleneck for this application.  I used the Raspberry Pi for my own amusement.</br></br>This website is deployed on Heroku using a free dyno</br></br>This website is still a work in progress.  There are known issues that will be addressed, maybe some enhancements.  This website is for demonstration purposes.  Thanks for visiting.</br></br><a style=color:yellow href="https://github.com/greghorne/mappy" target="_blank">GitHub Repository</a></div>
	
	<input id='pac-input' class='controls' type='text' placeholder='Search Box' style='border-radius:3px; background-color:#fff; visibility: hidden'>
	<div id="map"></div>
	<script type="text/javascript">


	// default location and zooms
	var _myLatitude = 36.068250;
	var _myLongitude = -95.843579;
	var _myZoom = 4;
	var _myZoomGeoLocation = 17;
	var _myDrawingManager;

	var _myInfoWindow;

	var db_server_port = 2346


	$(document).ready(function() {

		if (document.getElementById('map')) {
		    $("#flip").click(function(){
		        $("#panel").slideToggle("slow");
		    });

		   	//////////////////////////////////////	
			// Initializes search box
			////////////////////////////////////////
			function initSearchBoxControl() {

				var input = document.getElementById('pac-input');
				var searchBox = new google.maps.places.SearchBox(input);
				map.controls[google.maps.ControlPosition.TOP_CENTER].push(input);

				map.addListener('bounds_changed', function() {
					searchBox.setBounds(map.getBounds());
				});

				searchBox.addListener('places_changed', function() {
					var places = searchBox.getPlaces();
					if (places.length == 0) { return; }
					clearMap();

					// For each place, get the icon, name and location.
					var bounds = new google.maps.LatLngBounds();
					places.forEach(function(place) {
						var icon = {
							url: place.icon,
							size: new google.maps.Size(71, 71),
							origin: new google.maps.Point(0, 0),
							anchor: new google.maps.Point(17, 34),
							scaledSize: new google.maps.Size(25, 25)
						};

						// Create a marker for each place.
						markers.push(new google.maps.Marker({
							map: map,
							icon: icon,
							title: place.name,
							position: place.geometry.location
						}));

					});

					doIsochrone(places[0].geometry.location.lat(), places[0].geometry.location.lng(), db_server_port)
				})
			};
			//////////////////////////////////////	


	  		// Create a map object and specify the DOM element for display.
	  		var map = new google.maps.Map(document.getElementById('map'), {
	    		center: {lat: _myLatitude, lng: _myLongitude},
	    		scrollwheel: true,
	    		zoom: _myZoom,
	    		// scaleControl: true,
	    		streetViewControl: false,
	    		zoomControl: true,
	    		mapTypeId: 'terrain'
  			});


		  	(function() {
		  		// drawing manager set up (drawing tools)
		  		_myDrawingManager = new google.maps.drawing.DrawingManager({
		  			drawingMode: google.maps.drawing.OverlayType.DEFAULT,
		  			drawingControl: true,
		  			drawingControlOptions: {
		  			 	position: google.maps.ControlPosition.LEFT_TOP,
		  				drawingModes: ['marker']
		  				// drawingModes: ['polygon', 'circle', 'rectangle', 'marker']
		  			}
		  		});
		  		_myDrawingManager.setMap(map);
			})();

			initSearchBoxControl();

  			var markers = [];

  			// Set up of custom button controls
			var customControlsDiv = document.createElement('div');
			var customControls = new initCustomControls(customControlsDiv, map);
			customControlsDiv.index = 1;
			customControlsDiv.style['padding-top'] = '10px';
			map.controls[google.maps.ControlPosition.TOP_RIGHT].push(customControlsDiv);

	  		google.maps.event.addListener(_myDrawingManager, 'markercomplete', function(event) {
	  				// remove marker the event automatically sets

	  				event.setMap(null);
	  				doIsochrone(event.getPosition().lat(), event.getPosition().lng(), db_server_port)
	  		});
		};


   	//////////////////////////////////////	
	// Initializes search box
	////////////////////////////////////////
	function initSearchBoxControl() {

		var input = document.getElementById('pac-input');
		var searchBox = new google.maps.places.SearchBox(input);
		map.controls[google.maps.ControlPosition.TOP_CENTER].push(input);

		map.addListener('bounds_changed', function() {
			searchBox.setBounds(map.getBounds());
		});

		searchBox.addListener('places_changed', function() {
			var places = searchBox.getPlaces();
			if (places.length == 0) { return; }
			clearMap();

			// For each place, get the icon, name and location.
			var bounds = new google.maps.LatLngBounds();
			places.forEach(function(place) {
				var icon = {
					url: place.icon,
					size: new google.maps.Size(71, 71),
					origin: new google.maps.Point(0, 0),
					anchor: new google.maps.Point(17, 34),
					scaledSize: new google.maps.Size(25, 25)
				};

				// Create a marker for each place.
				markers.push(new google.maps.Marker({
					map: map,
					icon: icon,
					title: place.name,
					position: place.geometry.location
				}));

			});

			doIsochrone(places[0].geometry.location.lat(), places[0].geometry.location.lng(), db_server_port)
		})
	};
	//////////////////////////////////////	


	// //////////////////////////////////////	
	// // Generates isochrone
	// //////////////////////////////////////	
    function doIsochrone(lat, lng, db_server_port) {

		$.ajax({
			url:  "/check_region.json",
			type: "POST",
			data: {lat: lat, lng: lng, db_server_port: db_server_port}
		}).done(function (result) {

			if (result.result === true) {


				// // remove any marker in markers[]
				// if (markers.length > 0) {
				// 	for (var counter = 0; counter < markers.length; counter++) {
				// 		markers[counter].setMap(null);
				// 		markers.pop();
				// 	}
				// }

				clearMap();

				// create a new marker
				var latlng = { lat: lat, lng: lng };
				var marker = new google.maps.Marker({
					position: latlng,
					map: map
				})

				map.setCenter({lat: lat, lng: lng})
			
				// add marker to markers[] and set/create it on the map
				markers.push(marker);
				markers[0].setMap(map);

				// if (typeof(db_server_port) === 'undefined') db_server_port = 2346;

				$.ajax({
					url:  "/create_isochrone.json",
					type: "POST",
					data: {latitude: lat,
						   longitude: lng,
						   time: 180,
							db_server_port: db_server_port}
				}).done(function (result) {


					// clear map of previous map features
					map.data.forEach(function(feature) {
						map.data.remove(feature);
					})
					console.log("Area = " + Math.round(result.area / 1000000 * 100) / 100 + " km^2")

					// ====================================================================================
					// if an isochrone is created, then the area will always be greater than zero
					// once it is buffered
					// ====================================================================================
					if (result.area >= 0) {
					// ====================================================================================
					// ====================================================================================

						// ============================================================
						// this is the r360 generated isochrone
						var numberIndicies = result.coordinates[0][0].length
						var coords = []

						for (n = 0; n < numberIndicies; n++) {
							lat = result.coordinates[0][0][n][1]
							lng = result.coordinates[0][0][n][0]
							coords.push({lat: lat, lng: lng})
						}

						// define new polygon and add to map
						var polygon_r360 = new google.maps.Data.Polygon([coords]);
						// map.data.setStyle({
						// 	strokeColor: '#4286f4',
						// 	strokeOpacity: 0.8,
						// 	strokeWeight: 2,
						// 	fillColor: '#4286f4',
						// 	fillOpacity: .3
						// });

						map.data.add({
							geometry: polygon_r360
						});
						// ============================================================

						// ============================================================
						// this will only capture the outer ring of the buffer polygon
						var buffer = [];
						var length = result.buffer.length;
						var flag = false;
						for (n = 0; n < length; n++) {
							split = result.buffer[n].split(" ")

							if (split[0][0] !== "(" && !flag) {
								lng = split[0];
								lat = split[1];
								buffer.push({lat: parseFloat(lat), lng: parseFloat(lng)})
							} else {
								flag = true
							}
						}

						// define new polygon and add to map
						var polygon_buffer = new google.maps.Data.Polygon([buffer]);
						map.data.setStyle({
							strokeColor: '#c43844',
							strokeOpacity: 0.8,
							strokeWeight: 2,
							fillColor: '#f4d442',
							fillOpacity: .3
						});

						map.data.add({
							geometry: polygon_buffer
						});
						// ============================================================

						// fit map to isochrone polygon
						var bounds = new google.maps.LatLngBounds();
						polygon_buffer.forEachLatLng(function (point) { 
							bounds.extend(new google.maps.LatLng(point.lat(), point.lng()));
						});
			            map.fitBounds(bounds); 
			            alertify.success("Estimated Demographics</br>(2010 Census Block)</br></br>" + "population: " + Math.round(result.pop).toLocaleString() + "</br>housing: " + Math.round(result.housing).toLocaleString())
		            }
		            else alertify.warning("Unable to calculate demographics");
				});
			} else {
				alertify.error("Calculations only available within USA.  Please try again.")
			}

		});
	
	};
	// //////////////////////////////////////	


	//////////////////////////////
	// Custom button controls set up
	//////////////////////////////
	function initCustomControls(controlDiv, map) {

		// We set up a variable for this since we're adding event listeners later.
		var control = this;

		// Set CSS for the control border
		var geolocateUI = document.createElement('div');
		geolocateUI.id = 'geolocateUI';
		geolocateUI.title = 'Click to geolocate on map';
		controlDiv.appendChild(geolocateUI);

		// Set CSS for the control interior
		var geolocateText = document.createElement('div');
		geolocateText.id = 'geolocateText';
		geolocateText.innerHTML = 'Geolocate';
		geolocateUI.appendChild(geolocateText);

		// Click event for Geolocate
		geolocateUI.addEventListener('click', function() {
			var options = { timeout: 5000, enableHighAccuracy: true }
			navigator.geolocation.getCurrentPosition(success, error, options)
		});
		//////////////////////////////


		//////////////////////////////
		// Clear Map
		//////////////////////////////
		var clearMapUI = document.createElement('div');
		clearMapUI.id = 'clearMapUI';
		clearMapUI.title = 'Click to clear map';
		controlDiv.appendChild(clearMapUI);

		// Set CSS for the control interior
		var clearMapText = document.createElement('div');
		clearMapText.id = 'clearMapText';
		clearMapText.innerHTML = 'Clear Map';
		clearMapUI.appendChild(clearMapText);

		// Set up the click event listener for 'Set Center': Set the center of the
		// control to the current center of the map.
		clearMapUI.addEventListener('click', function() {
			clearMap();
		});
		//////////////////////////////

		//////////////////////////////
		// Change DB Server
		//////////////////////////////
		var changeDBServerUI = document.createElement('div');
		changeDBServerUI.id = 'changeDBServerUI';
		changeDBServerUI.title = 'Change DB Server';
		controlDiv.appendChild(changeDBServerUI);

		// Set CSS for the control interior
		var changeDBServerText = document.createElement('div');
		changeDBServerText.id = 'changeDBServerText';
		changeDBServerText.innerHTML = 'DB Server';
		changeDBServerUI.appendChild(changeDBServerText);

		changeDBServerUI.addEventListener('click', function() {
		    if (db_server_port === 2345) { 
		    	db_server_port = 2346;
		    	alertify.alert("<center>MappyData</center>", "<center>PostgreSQL/PostGIS Server is now set to:</br></br><a href='https://www.raspberrypi.org/products/raspberry-pi-2-model-b/' target='_blank'>Raspberry Pi 2 - Raspbian</a> (slowest)</br></br>(your phone is probably faster than this device)</center>");
		    } else {
		    	db_server_port = 2345;
		    	alertify.alert("<center>MappyData</center>", "<center>PostgreSQL/PostGIS Server is now set to:</br></br><a href='https://www.zotac.com/us/product/mini_pcs/bi320-windows-81-bing-0' target='_blank'>Zotac BI320 - Ubuntu</a> (fastest)</br></br>(well, maybe not as slow)<center>");
		    }
		    // console.log("DB Port: " + db_server_port)
		});
		//////////////////////////////
	};
	//////////////////////////////


	////////////////////////////////////////	
	// Geolocation 'success' function
	////////////////////////////////////////
	function success(location) {
		doIsochrone(location.coords.latitude, location.coords.longitude, db_server_port);
	};
	////////////////////////////////////////
  	

	////////////////////////////////////////
	// Geolocation 'error' function
	////////////////////////////////////////
	function error(error) {
		alert("Error: getCurrentPosition: " + error + " (HTTPS required for this function)")
	}
	////////////////////////////////////////


	//////////////////////////////
	/// clears map of infoWindow, Shapes and/or marker
	function clearMap() {

		// clear mafrkers
		if (typeof markers !== 'undefined') {
			for (counter = 0; counter < markers.length; counter++) {
				markers[counter].setMap(null);
			}
			markers = [];
		}

		map.data.forEach(function(feature) {
			map.data.remove(feature);
		})
	};
	//////////////////////////////

});
	  	

	</script>


</body>
</html>
